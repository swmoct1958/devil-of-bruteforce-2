### 第2章：設計図 ―― 制約充足と枝切りの論理

多言語で実装を比較する前に、まずは言語に依存しない共通の「論理の設計図」を定義します。n-Queen問題と同様に、広大な探索空間を効率よく渡り歩くためには、数学的制約をいかに早くコードに落とし込むかが鍵となります。

#### 2-1. 言語に依存しないアルゴリズムの日本語骨子
基本戦略は、空のマス目に $1$ から $n^2$ までの未使用の数字を順に埋めていくバックトラッキング法です。
1. 未使用の数字から一つ選び、現在のマスに配置する。
2. その数字を置いたことで、すでに確定した行・列・対角線の和が $S$ と矛盾しないか確認する。
3. 矛盾がなければ次のマスへ進み（再帰）、矛盾があれば数字を取り除いて別の候補を試す（枝切り）。

#### 2-2. 枝切りの極意：行・列・対角線が「和」を超えた瞬間の探索打ち切り
魔法陣の探索を加速させる肝は、「いつ、探索を諦めるか」にあります。
* **超過チェック**: まだマスが埋まっていない途中段階でも、その時点の合計が $S$ を超えていれば、その先を探索しても解は見つかりません。
* **行の完成**: 一行が埋まった瞬間にその和が $S$ でなければ、即座にその枝を切り捨てます。
* **最後のマスの確定**: 各行・列の最後のマスは、選択の余地はありません。残りの合計から逆算される特定の数値である必要があります。その数値が「未使用」かつ「範囲内」でなければ、その時点で失敗とみなします。

#### 2-3. 対称性の排除：回転・反転による重複解をどう定義するか
ひとつの魔法陣が見つかると、それを回転（90度、180度、270度）させたり、鏡のように反転させたりすることで、合計 8 通りのバリエーションが生まれます。
これらをすべて個別の解としてカウントすると、本質的な解の 8 倍の数が出てしまいます。これを防ぐために、例えば「左上の角が右上の角より小さい」といった制約を設け、正規化された解のみを抽出する論理を実装に組み込みます。
